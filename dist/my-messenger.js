!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((e="undefined"!=typeof globalThis?globalThis:e||self).MyMessenger={})}(this,(function(e){"use strict";class s{flag="";debug=!1;debugPrefix="";events={};constructor(e,s){this.flag=e,this.debug=s,this.debugPrefix=`[messenager.${this.flag}]`.padEnd(20,">")}on(e,s){"function"==typeof s&&(this.events[e]||(this.events[e]=[]),this.events[e].push(s))}off(e,s){if(e&&this.events[e]){if(s&&"function"==typeof s){const t=this.events[e].indexOf(s);this.events[e].splice(t,1)}this.events[e]=void 0}}offAll(){Object.keys(this.events).forEach(this.off)}invoke(e,...s){if(e&&this.events[e])for(const t of this.events[e])t.call(this,...s)}showDebug(...e){this.debug&&console.info(this.debugPrefix,...e)}showError(e){this.debug&&console.error(this.debugPrefix,"string"==typeof e?e:e.message)}}class t extends s{static debug=!1;shakehandTimes=0;shakehandTimer=null;connected=!1;constructor(e){"string"==typeof e&&(e=document.querySelector(e)),super("parent",t.debug),this.iframe=e,this.onMessage=this.onMessage.bind(this),window.addEventListener("message",this.onMessage)}connect(){return this.checkLoaded().then((()=>this.shakehand())).then((()=>{this.connected=!0,this.showDebug("connected")}))}checkLoaded(){return new Promise(((e,s)=>{if(this.showDebug("checkLoaded"),this.iframe){this.iframe.addEventListener("load",(()=>{e()}));try{const s=this.iframe.contentDocument||this.iframe.contentWindow.document;s&&"complete"===s.readyState&&e()}catch(s){e()}}else s("no iframe found")}))}shakehand(){return new Promise(((e,s)=>{const t=e=>{if(this.shakehandTimes>50)return clearInterval(this.shakehandTimer),this.showError("shakehand failed, max times"),void s("shakehand failed, max times");this.shakehandTimes++,this.showDebug(`shakehand: ${this.shakehandTimes}`,e),this.send("shakehand",{ack:e})};this.shakehandTimer=setInterval(t,100),this.on("shakehand-reply",(({ack:s})=>{s&&(clearInterval(this.shakehandTimer),t(!0),this.off("shakehand-reply"),e())}))}))}send(e,s){if(this.iframe&&this.iframe.contentWindow)try{this.iframe.contentWindow.postMessage({event:e,data:s},this.iframe.src)}catch(e){this.showError(e)}}onMessage(e){if(!this.iframe.src.includes(e.origin))return;const{event:s,data:t}=e.data;this.showDebug("onMessage",e.data),this.invoke(s,t)}close(){this.connected=!1,window.removeEventListener("message",this.onMessage),this.offAll()}}class n extends s{static debug=!1;origin="";connected=!1;constructor(e){super("child",n.debug),this.origin=e||document.referrer,this.onMessage=this.onMessage.bind(this),window.addEventListener("message",this.onMessage)}connect(){return new Promise((e=>{this.on("shakehand",(s=>{this.showDebug("on.shakehand",s),this.replyShakehand(s).then(e)}))}))}replyShakehand({ack:e}){return new Promise((s=>{if(e)return this.showDebug("connected"),this.connected=!0,this.off("shakehand"),void s();this.showDebug("shakehand-reply"),this.send("shakehand-reply",{ack:!0})}))}send(e,s){if(window.parent&&this.origin)try{window.parent.postMessage({event:e,data:s},this.origin)}catch(e){this.showError(e)}}onMessage(e){if(this.origin||(this.origin=e.origin),!this.origin.includes(e.origin))return;const{event:s="",data:t}=e.data||{};this.showDebug("onMessage",e.data),this.invoke(s,t)}close(){this.connected=!1,window.removeEventListener("message",this.onMessage),this.offAll()}}const i={Parent:t,Child:n};e.default=i,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=my-messenger.js.map
