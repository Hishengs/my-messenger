!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).MyMessenger={})}(this,(function(e){"use strict";function n(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function t(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&s(e,n)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,n){return(s=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?u(e):n}function f(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,i=a(e);if(n){var o=a(this).constructor;t=Reflect.construct(i,arguments,o)}else t=i.apply(this,arguments);return c(this,t)}}var h=function(){function e(t,i){n(this,e),o(this,"flag",""),o(this,"debug",!1),o(this,"debugPrefix",""),o(this,"events",{}),o(this,"uid",+new Date),this.flag=t+"_"+this.uid,this.debug=i,this.debugPrefix="[messenager."+this.flag+"] >>>"}return i(e,[{key:"on",value:function(e,n){"function"==typeof n&&(this.events[e]||(this.events[e]=[]),this.events[e].push(n))}},{key:"off",value:function(e,n){if(e&&this.events[e]){if(n&&"function"==typeof n){var t=this.events[e].indexOf(n);this.events[e].splice(t,1)}this.events[e]=void 0}}},{key:"offAll",value:function(){var e=this;Object.keys(this.events).forEach((function(n){return e.off(n)}))}},{key:"invoke",value:function(e){for(var n=this,t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];e&&this.events[e]&&this.events[e].forEach((function(e){e.call.apply(e,[n].concat(i))}))}},{key:"showDebug",value:function(){for(var e,n=arguments.length,t=new Array(n),i=0;i<n;i++)t[i]=arguments[i];this.debug&&(e=console).info.apply(e,[this.debugPrefix].concat(t))}},{key:"showError",value:function(e){this.debug&&console.error(this.debugPrefix,"string"==typeof e?e:e.message)}}]),e}(),d=function(e){r(a,e);var t=f(a);function a(e){var i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n(this,a),"string"==typeof e&&(e=document.querySelector(e)),o(u(i=t.call(this,"parent",a.debug)),"shakehandTimes",0),o(u(i),"shakehandTimer",null),o(u(i),"connected",!1),o(u(i),"timeout",5e3),o(u(i),"interval",100),o(u(i),"maxShakeTimes",50),i.iframe=e,i.timeout=r.timeout||i.timeout,i.interval=r.interval||i.interval,i.maxShakeTimes=Math.floor(i.timeout/i.interval),i.targetOrigin=r.targetOrigin||e.src,i.onMessage=i.onMessage.bind(u(i)),window.addEventListener("message",i.onMessage),i}return i(a,[{key:"connect",value:function(){var e=this;return this.checkLoaded().then((function(){return e.shakehand()})).then((function(){e.connected=!0,e.showDebug("connected")}))}},{key:"checkLoaded",value:function(){var e=this;return new Promise((function(n,t){if(e.showDebug("checkLoaded"),e.iframe){e.iframe.addEventListener("load",(function(){n()}));try{var i=e.iframe.contentDocument||e.iframe.contentWindow.document;i&&"complete"===i.readyState&&n()}catch(e){n()}}else t("no iframe found")}))}},{key:"shakehand",value:function(){var e=this;return new Promise((function(n,t){var i=function(n){if(e.shakehandTimes>=e.maxShakeTimes)return clearInterval(e.shakehandTimer),e.showError("shakehand failed, max times"),void t("shakehand failed, max times");e.shakehandTimes++,e.showDebug("shakehand: ".concat(e.shakehandTimes),n),e.send("shakehand",{ack:n})};i(),e.shakehandTimer=setInterval(i,e.interval),e.on("shakehand-reply",(function(t){t.ack&&(clearInterval(e.shakehandTimer),i(!0),e.off("shakehand-reply"),n())}))}))}},{key:"send",value:function(e,n){if(this.iframe&&this.iframe.contentWindow)try{this.iframe.contentWindow.postMessage({event:e,data:n},this.targetOrigin)}catch(e){this.showError(e)}}},{key:"onMessage",value:function(e){if(this.iframe&&this.iframe.contentWindow===e.source){var n=e.data,t=n.event,i=n.data;this.showDebug("onMessage",e),this.invoke(t,i,e)}}},{key:"close",value:function(){this.connected=!1,window.removeEventListener("message",this.onMessage),this.offAll()}}]),a}(h);o(d,"debug",!1);var l=function(e){r(a,e);var t=f(a);function a(e){var i;return n(this,a),o(u(i=t.call(this,"child",a.debug)),"origin",""),o(u(i),"connected",!1),i.origin=e||document.referrer||"*",i.onMessage=i.onMessage.bind(u(i)),window.addEventListener("message",i.onMessage),i}return i(a,[{key:"connect",value:function(){var e=this;return new Promise((function(n){e.on("shakehand",(function(t){e.showDebug("on.shakehand",t),e.replyShakehand(t).then(n)}))}))}},{key:"replyShakehand",value:function(e){var n=this,t=e.ack;return new Promise((function(e){if(t)return n.showDebug("connected"),n.connected=!0,n.off("shakehand"),void e();n.showDebug("shakehand-reply"),n.send("shakehand-reply",{ack:!0})}))}},{key:"send",value:function(e,n){if(window.parent&&this.origin)try{window.parent.postMessage({event:e,data:n},this.origin)}catch(e){this.showError(e)}}},{key:"onMessage",value:function(e){var n=e.data||{},t=n.event,i=void 0===t?"":t,o=n.data;this.showDebug("onMessage",e.data),this.invoke(i,o,e)}},{key:"close",value:function(){this.connected=!1,window.removeEventListener("message",this.onMessage),this.offAll()}}]),a}(h);o(l,"debug",!1);var v={Parent:d,Child:l};e.default=v,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=my-messenger.js.map
