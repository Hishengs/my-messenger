{"version":3,"file":"my-messenger.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(e => this.off(e));\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n  timeout = 5000;\n  interval = 100;\n  maxShakeTimes = 50;\n\n  constructor (iframe, options = {}) {\n    if (typeof iframe === 'string') {\n      iframe = document.querySelector(iframe);\n    }\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.timeout = options.timeout || this.timeout;\n    this.interval = options.interval || this.interval;\n    this.maxShakeTimes = Math.floor(this.timeout / this.interval);\n    this.targetOrigin = options.targetOrigin || iframe.src;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.checkLoaded()\n      .then(() => this.shakehand())\n      .then(() => {\n        this.connected = true;\n        this.showDebug('connected');\n      });\n  }\n\n  // check if iframe loaded\n  checkLoaded () {\n    return new Promise((resolve, reject) => {\n      this.showDebug('checkLoaded');\n      if (!this.iframe) {\n        reject('no iframe found');\n        return;\n      }\n      this.iframe.addEventListener('load', () => {\n        resolve();\n      });\n      try {\n        const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;\n        if (iframeDoc && iframeDoc.readyState === 'complete') {\n          resolve();\n        }\n      } catch (e) {\n        // throw cross origin access error if loaded, otherwise return document\n        resolve();\n      }\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > this.maxShakeTimes) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, this.interval);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.targetOrigin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (this.targetOrigin !== '*' && !this.targetOrigin.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin || document.referrer;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (!this.origin) this.origin = e.origin;\n    if (!this.origin.includes(e.origin)) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","debugPrefix","events","constructor","this","padEnd","on","event","callback","push","off","index","indexOf","splice","undefined","offAll","Object","keys","forEach","e","invoke","args","cb","call","showDebug","console","info","showError","error","message","MessengerParent","Base","shakehandTimes","shakehandTimer","connected","timeout","interval","maxShakeTimes","iframe","options","document","querySelector","super","Math","floor","targetOrigin","src","onMessage","bind","window","addEventListener","connect","checkLoaded","then","shakehand","Promise","resolve","reject","iframeDoc","contentDocument","contentWindow","readyState","shake","ack","clearInterval","send","setInterval","data","postMessage","includes","origin","close","removeEventListener","MessengerChild","referrer","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"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"}