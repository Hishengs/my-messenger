{"version":3,"file":"my-messenger.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(this.off);\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nconst MAX_SHAKE_HAND = 50;\nconst SHAKE_HAND_INTERVAL = 100;\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n\n  constructor (iframe) {\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.shakehand().then(() => {\n      this.connected = true;\n      this.showDebug('connected');\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > MAX_SHAKE_HAND) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, SHAKE_HAND_INTERVAL);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.iframe.src);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (!this.iframe.src.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (!this.origin) this.origin = e.origin;\n    if (this.origin !== e.origin) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","debugPrefix","events","constructor","this","padEnd","on","event","callback","push","off","index","indexOf","splice","undefined","offAll","Object","keys","forEach","invoke","args","cb","call","showDebug","console","info","showError","e","error","message","MessengerParent","Base","shakehandTimes","shakehandTimer","connected","iframe","super","onMessage","bind","window","addEventListener","connect","shakehand","then","Promise","resolve","reject","shake","ack","clearInterval","send","setInterval","data","contentWindow","postMessage","src","includes","origin","close","removeEventListener","MessengerChild","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"mPAAe,MAAMA,EACnBC,KAAO,GACPC,OAAQ,EACRC,YAAc,GACdC,OAAS,GAETC,YAAaJ,EAAMC,GACjBI,KAAKL,KAAOA,EACZK,KAAKJ,MAAQA,EACbI,KAAKH,YAAc,eAAeG,KAAKL,QAAQM,OAAO,GAAI,KAG5DC,GAAGC,EAAOC,GACgB,mBAAbA,IACNJ,KAAKF,OAAOK,KAAQH,KAAKF,OAAOK,GAAS,IAC9CH,KAAKF,OAAOK,GAAOE,KAAKD,IAG1BE,IAAIH,EAAOC,GACT,GAAID,GAASH,KAAKF,OAAOK,GAAQ,CAC/B,GAAIC,GAAgC,mBAAbA,EAAyB,CAC9C,MAAMG,EAAQP,KAAKF,OAAOK,GAAOK,QAAQJ,GACzCJ,KAAKF,OAAOK,GAAOM,OAAOF,EAAO,GACjCP,KAAKF,OAAOK,QAASO,GAI3BC,SACEC,OAAOC,KAAKb,KAAKF,QAAQgB,QAAQd,KAAKM,KAGxCS,OAAQZ,KAAUa,GAChB,GAAIb,GAASH,KAAKF,OAAOK,GACvB,IAAK,MAAMc,KAAMjB,KAAKF,OAAOK,GAC3Bc,EAAGC,KAAKlB,QAASgB,GAKvBG,aAAcH,GACZhB,KAAKJ,OAASwB,QAAQC,KAAKrB,KAAKH,eAAgBmB,GAGlDM,UAAWC,GACTvB,KAAKJ,OAASwB,QAAQI,MAAMxB,KAAKH,YAA0B,iBAAN0B,EAAiBA,EAAIA,EAAEE,UCvCjE,MAAMC,UAAwBC,EAC3C/B,cAAe,EACfgC,eAAiB,EACjBC,eAAiB,KACjBC,WAAY,EAEZ/B,YAAagC,GACXC,MAAM,SAAUN,EAAgB9B,OAChCI,KAAK+B,OAASA,EACd/B,KAAKiC,UAAYjC,KAAKiC,UAAUC,KAAKlC,MACrCmC,OAAOC,iBAAiB,UAAWpC,KAAKiC,WAG1CI,UACE,OAAOrC,KAAKsC,YAAYC,MAAK,KAC3BvC,KAAK8B,WAAY,EACjB9B,KAAKmB,UAAU,gBAInBmB,YACE,OAAO,IAAIE,SAAQ,CAACC,EAASC,KAC3B,MAAMC,EAASC,IACb,GAAI5C,KAAK4B,eA1BM,GA8Bb,OAHAiB,cAAc7C,KAAK6B,gBACnB7B,KAAKsB,UAAU,oCACfoB,EAAO,+BAGT1C,KAAK4B,iBACL5B,KAAKmB,UAAU,cAAcnB,KAAK4B,iBAAkBgB,GACpD5C,KAAK8C,KAAK,YAAa,CAAEF,IAAAA,KAG3B5C,KAAK6B,eAAiBkB,YAAYJ,EApCZ,KAsCtB3C,KAAKE,GAAG,mBAAmB,EAAG0C,IAAAA,MAExBA,IAEFC,cAAc7C,KAAK6B,gBAEnBc,GAAM,GACN3C,KAAKM,IAAI,mBAETmC,WAMRK,KAAM3C,EAAO6C,GACX,GAAIhD,KAAK+B,QAAU/B,KAAK+B,OAAOkB,cAC7B,IACEjD,KAAK+B,OAAOkB,cAAcC,YAAY,CAAE/C,MAAAA,EAAO6C,KAAAA,GAAQhD,KAAK+B,OAAOoB,KACnE,MAAO5B,GACPvB,KAAKsB,UAAUC,IAKrBU,UAAWV,GACT,IAAKvB,KAAK+B,OAAOoB,IAAIC,SAAS7B,EAAE8B,QAAS,OACzC,MAAMlD,MAAEA,EAAK6C,KAAEA,GAASzB,EAAEyB,KAC1BhD,KAAKmB,UAAU,YAAaI,EAAEyB,MAC9BhD,KAAKe,OAAOZ,EAAO6C,GAGrBM,QACEtD,KAAK8B,WAAY,EACjBK,OAAOoB,oBAAoB,UAAWvD,KAAKiC,WAC3CjC,KAAKW,UC1EM,MAAM6C,UAAuB7B,EAC1C/B,cAAe,EACfyD,OAAS,GACTvB,WAAY,EAEZ/B,YAAasD,GACXrB,MAAM,QAASwB,EAAe5D,OAC9BI,KAAKqD,OAASA,EACdrD,KAAKiC,UAAYjC,KAAKiC,UAAUC,KAAKlC,MACrCmC,OAAOC,iBAAiB,UAAWpC,KAAKiC,WAG1CI,UACE,OAAO,IAAIG,SAAQC,IAEjBzC,KAAKE,GAAG,aAAc8C,IACpBhD,KAAKmB,UAAU,eAAgB6B,GAC/BhD,KAAKyD,eAAeT,GAAMT,KAAKE,SAKrCgB,gBAAgBb,IAAEA,IAChB,OAAO,IAAIJ,SAAQC,IAEjB,GAAIG,EAKF,OAJA5C,KAAKmB,UAAU,aACfnB,KAAK8B,WAAY,EACjB9B,KAAKM,IAAI,kBACTmC,IAGFzC,KAAKmB,UAAU,mBACfnB,KAAK8C,KAAK,kBAAmB,CAAEF,KAAK,OAIxCE,KAAM3C,EAAO6C,GACX,GAAIb,OAAOuB,QAAU1D,KAAKqD,OACxB,IACElB,OAAOuB,OAAOR,YAAY,CAAE/C,MAAAA,EAAO6C,KAAAA,GAAQhD,KAAKqD,QAChD,MAAO9B,GACPvB,KAAKsB,UAAUC,IAKrBU,UAAUV,GAER,GADKvB,KAAKqD,SAAQrD,KAAKqD,OAAS9B,EAAE8B,QAC9BrD,KAAKqD,SAAW9B,EAAE8B,OAAQ,OAC9B,MAAMlD,MAAEA,EAAQ,GAAE6C,KAAEA,GAASzB,EAAEyB,MAAQ,GACvChD,KAAKmB,UAAU,YAAaI,EAAEyB,MAC9BhD,KAAKe,OAAOZ,EAAO6C,GAGrBM,QACEtD,KAAK8B,WAAY,EACjBK,OAAOoB,oBAAoB,UAAWvD,KAAKiC,WAC3CjC,KAAKW,gBCzDHgD,EAAY,QAChBC,QACAC"}