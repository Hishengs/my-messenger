{"version":3,"file":"my-messenger.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(e => this.off(e));\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nconst MAX_SHAKE_HAND = 50;\nconst SHAKE_HAND_INTERVAL = 100;\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n\n  constructor (iframe) {\n    if (typeof iframe === 'string') {\n      iframe = document.querySelector(iframe);\n    }\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.checkLoaded()\n      .then(() => this.shakehand())\n      .then(() => {\n        this.connected = true;\n        this.showDebug('connected');\n      });\n  }\n\n  // check if iframe loaded\n  checkLoaded () {\n    return new Promise((resolve, reject) => {\n      this.showDebug('checkLoaded');\n      if (!this.iframe) {\n        reject('no iframe found');\n        return;\n      }\n      this.iframe.addEventListener('load', () => {\n        resolve();\n      });\n      try {\n        const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;\n        if (iframeDoc && iframeDoc.readyState === 'complete') {\n          resolve();\n        }\n      } catch (e) {\n        // throw cross origin access error if loaded, otherwise return document\n        resolve();\n      }\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > MAX_SHAKE_HAND) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, SHAKE_HAND_INTERVAL);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.iframe.src);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (!this.iframe.src.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin || document.referrer;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (!this.origin) this.origin = e.origin;\n    if (!this.origin.includes(e.origin)) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","debugPrefix","events","constructor","this","padEnd","on","event","callback","push","off","index","indexOf","splice","undefined","offAll","Object","keys","forEach","e","invoke","args","cb","call","showDebug","console","info","showError","error","message","MessengerParent","Base","shakehandTimes","shakehandTimer","connected","iframe","document","querySelector","super","onMessage","bind","window","addEventListener","connect","checkLoaded","then","shakehand","Promise","resolve","reject","iframeDoc","contentDocument","contentWindow","readyState","shake","ack","clearInterval","send","setInterval","data","postMessage","src","includes","origin","close","removeEventListener","MessengerChild","referrer","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"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"}