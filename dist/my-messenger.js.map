{"version":3,"file":"my-messenger.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n  uid = +new Date();\n\n  constructor (flag, debug) {\n    this.flag = flag + '_' + this.uid;\n    this.debug = debug;\n    this.debugPrefix = '[messenager.' + this.flag + '] >>>';\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(e => this.off(e));\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      this.events[event].forEach(cb => {\n        cb.call(this, ...args);\n      });\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n  timeout = 5000;\n  interval = 100;\n  maxShakeTimes = 50;\n\n  constructor (iframe, options = {}) {\n    if (typeof iframe === 'string') {\n      iframe = document.querySelector(iframe);\n    }\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.timeout = options.timeout || this.timeout;\n    this.interval = options.interval || this.interval;\n    this.maxShakeTimes = Math.floor(this.timeout / this.interval);\n    this.targetOrigin = options.targetOrigin || iframe.src;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.checkLoaded()\n      .then(() => this.shakehand())\n      .then(() => {\n        this.connected = true;\n        this.showDebug('connected');\n      });\n  }\n\n  // check if iframe loaded\n  checkLoaded () {\n    return new Promise((resolve, reject) => {\n      this.showDebug('checkLoaded');\n      if (!this.iframe) {\n        reject('no iframe found');\n        return;\n      }\n      this.iframe.addEventListener('load', () => {\n        resolve();\n      });\n      try {\n        const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;\n        if (iframeDoc && iframeDoc.readyState === 'complete') {\n          resolve();\n        }\n      } catch (e) {\n        // throw cross origin access error if loaded, otherwise return document\n        resolve();\n      }\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes >= this.maxShakeTimes) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      shake();\n      this.shakehandTimer = setInterval(shake, this.interval);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.targetOrigin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (!this.iframe || (this.iframe.contentWindow !== e.source)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e);\n    this.invoke(event, data, e);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin || document.referrer || '*';\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data, e);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","Date","this","uid","debugPrefix","event","callback","events","push","index","indexOf","splice","undefined","Object","keys","forEach","e","_this","off","args","cb","call","_this2","console","info","error","message","MessengerParent","iframe","options","document","querySelector","timeout","interval","maxShakeTimes","Math","floor","targetOrigin","src","onMessage","bind","window","addEventListener","checkLoaded","then","shakehand","connected","showDebug","Promise","resolve","reject","_this3","iframeDoc","contentDocument","contentWindow","readyState","shake","ack","_this4","shakehandTimes","clearInterval","shakehandTimer","showError","send","setInterval","on","data","postMessage","source","invoke","removeEventListener","offAll","Base","MessengerChild","origin","referrer","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"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"}