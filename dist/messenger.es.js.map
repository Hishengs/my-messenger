{"version":3,"file":"messenger.es.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(this.off);\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nconst MAX_SHAKE_HAND = 50;\nconst SHAKE_HAND_INTERVAL = 100;\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n\n  constructor (iframe) {\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.shakehand().then(() => {\n      this.connected = true;\n      this.showDebug('connected');\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > MAX_SHAKE_HAND) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, SHAKE_HAND_INTERVAL);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.iframe.src);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (!this.iframe.src.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (this.origin !== e.origin) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["Base","Parent","Child"],"mappings":"AAAe,MAAM,aAAa,CAAC;AACnC,EAAE,IAAI,GAAG,EAAE,CAAC;AACZ,EAAE,KAAK,GAAG,KAAK,CAAC;AAChB,EAAE,WAAW,GAAG,EAAE,CAAC;AACnB,EAAE,MAAM,GAAG,EAAE,CAAC;AACd;AACA,EAAE,WAAW,CAAC,CAAC,IAAI,EAAE,KAAK,EAAE;AAC5B,IAAI,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;AACrB,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;AACvB,IAAI,IAAI,CAAC,WAAW,GAAG,CAAC,YAAY,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC;AACnE,GAAG;AACH;AACA,EAAE,EAAE,CAAC,KAAK,EAAE,QAAQ,EAAE;AACtB,IAAI,IAAI,OAAO,QAAQ,KAAK,UAAU,EAAE,OAAO;AAC/C,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;AACrD,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;AACtC,GAAG;AACH;AACA,EAAE,GAAG,CAAC,KAAK,EAAE,QAAQ,EAAE;AACvB,IAAI,IAAI,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;AACrC,MAAM,IAAI,QAAQ,IAAI,OAAO,QAAQ,KAAK,UAAU,EAAE;AACtD,QAAQ,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC3D,QAAQ,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;AAC5C,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,SAAS,CAAC;AACvC,KAAK;AACL,GAAG;AACH;AACA,EAAE,MAAM,CAAC,GAAG;AACZ,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAC/C,GAAG;AACH;AACA,EAAE,MAAM,CAAC,CAAC,KAAK,EAAE,GAAG,IAAI,EAAE;AAC1B,IAAI,IAAI,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;AACrC,MAAM,KAAK,MAAM,EAAE,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;AAC3C,QAAQ,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,IAAI,CAAC,CAAC;AAC/B,OAAO;AACP,KAAK;AACL,GAAG;AACH;AACA,EAAE,SAAS,CAAC,CAAC,GAAG,IAAI,EAAE;AACtB,IAAI,IAAI,CAAC,KAAK,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,GAAG,IAAI,CAAC,CAAC;AAC1D,GAAG;AACH;AACA,EAAE,SAAS,CAAC,CAAC,CAAC,EAAE;AAChB,IAAI,IAAI,CAAC,KAAK,IAAI,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,KAAK,QAAQ,GAAG,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC;AACzF,GAAG;AACH;;AC5CA,MAAM,cAAc,GAAG,EAAE,CAAC;AAC1B,MAAM,mBAAmB,GAAG,GAAG,CAAC;AAChC;AACe,MAAM,eAAe,SAASA,aAAI,CAAC;AAClD,EAAE,OAAO,KAAK,GAAG,KAAK,CAAC;AACvB,EAAE,cAAc,GAAG,CAAC,CAAC;AACrB,EAAE,cAAc,GAAG,IAAI,CAAC;AACxB,EAAE,SAAS,GAAG,KAAK,CAAC;AACpB;AACA,EAAE,WAAW,CAAC,CAAC,MAAM,EAAE;AACvB,IAAI,KAAK,CAAC,QAAQ,EAAE,eAAe,CAAC,KAAK,CAAC,CAAC;AAC3C,IAAI,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACzB,IAAI,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AAC/C,IAAI,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;AACvD,GAAG;AACH;AACA,EAAE,OAAO,CAAC,GAAG;AACb,IAAI,OAAO,IAAI,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,MAAM;AACvC,MAAM,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;AAC5B,MAAM,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;AAClC,KAAK,CAAC,CAAC;AACP,GAAG;AACH;AACA,EAAE,SAAS,CAAC,GAAG;AACf,IAAI,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAK;AAC5C,MAAM,MAAM,KAAK,GAAG,CAAC,GAAG,KAAK;AAC7B,QAAQ,IAAI,IAAI,CAAC,cAAc,GAAG,cAAc,EAAE;AAClD,UAAU,aAAa,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;AAC7C,UAAU,IAAI,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC;AACxD,UAAU,MAAM,CAAC,6BAA6B,CAAC,CAAC;AAChD,UAAU,OAAO;AACjB,SAAS;AACT,QAAQ,IAAI,CAAC,cAAc,EAAE,CAAC;AAC9B,QAAQ,IAAI,CAAC,SAAS,CAAC,CAAC,WAAW,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC;AACjE,QAAQ,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC;AACxC,OAAO,CAAC;AACR;AACA,MAAM,IAAI,CAAC,cAAc,GAAG,WAAW,CAAC,KAAK,EAAE,mBAAmB,CAAC,CAAC;AACpE;AACA,MAAM,IAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,CAAC,EAAE,GAAG,EAAE,KAAK;AAC9C;AACA,QAAQ,IAAI,GAAG,EAAE;AACjB;AACA,UAAU,aAAa,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;AAC7C;AACA,UAAU,KAAK,CAAC,IAAI,CAAC,CAAC;AACtB,UAAU,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC;AACtC;AACA,UAAU,OAAO,EAAE,CAAC;AACpB,SAAS;AACT,OAAO,CAAC,CAAC;AACT,KAAK,CAAC,CAAC;AACP,GAAG;AACH;AACA,EAAE,IAAI,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE;AACrB,IAAI,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;AAClD,MAAM,IAAI;AACV,QAAQ,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AAChF,OAAO,CAAC,OAAO,CAAC,EAAE;AAClB,QAAQ,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;AAC1B,OAAO;AACP,KAAK;AACL,GAAG;AACH;AACA,EAAE,SAAS,CAAC,CAAC,CAAC,EAAE;AAChB,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,OAAO;AACpD,IAAI,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC,IAAI,CAAC;AACnC,IAAI,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC;AACxC,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;AAC7B,GAAG;AACH;AACA,EAAE,KAAK,CAAC,GAAG;AACX,IAAI,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;AAC3B,IAAI,MAAM,CAAC,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;AAC1D,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;AAClB,GAAG;AACH;;AC5Ee,MAAM,cAAc,SAASA,aAAI,CAAC;AACjD,EAAE,OAAO,KAAK,GAAG,KAAK,CAAC;AACvB,EAAE,MAAM,GAAG,EAAE,CAAC;AACd,EAAE,SAAS,GAAG,KAAK,CAAC;AACpB;AACA,EAAE,WAAW,CAAC,CAAC,MAAM,EAAE;AACvB,IAAI,KAAK,CAAC,OAAO,EAAE,cAAc,CAAC,KAAK,CAAC,CAAC;AACzC,IAAI,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;AACzB,IAAI,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AAC/C,IAAI,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;AACvD,GAAG;AACH;AACA,EAAE,OAAO,CAAC,GAAG;AACb,IAAI,OAAO,IAAI,OAAO,CAAC,OAAO,IAAI;AAClC;AACA,MAAM,IAAI,CAAC,EAAE,CAAC,WAAW,EAAE,CAAC,IAAI,KAAK;AACrC,QAAQ,IAAI,CAAC,SAAS,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;AAC7C,QAAQ,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AAChD,OAAO,CAAC,CAAC;AACT,KAAK,CAAC,CAAC;AACP,GAAG;AACH;AACA,EAAE,cAAc,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE;AAC3B,IAAI,OAAO,IAAI,OAAO,CAAC,OAAO,IAAI;AAClC;AACA,MAAM,IAAI,GAAG,EAAE;AACf,QAAQ,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;AACpC,QAAQ,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;AAC9B,QAAQ,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AAC9B,QAAQ,OAAO,EAAE,CAAC;AAClB,QAAQ,OAAO;AACf,OAAO;AACP,MAAM,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,CAAC;AACxC,MAAM,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;AAClD,KAAK,CAAC,CAAC;AACP,GAAG;AACH;AACA,EAAE,IAAI,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE;AACrB,IAAI,IAAI,MAAM,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,EAAE;AACtC,MAAM,IAAI;AACV,QAAQ,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;AAChE,OAAO,CAAC,OAAO,CAAC,EAAE;AAClB,QAAQ,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;AAC1B,OAAO;AACP,KAAK;AACL,GAAG;AACH;AACA,EAAE,SAAS,CAAC,CAAC,EAAE;AACf,IAAI,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC,MAAM,EAAE,OAAO;AACzC,IAAI,MAAM,EAAE,KAAK,GAAG,EAAE,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC;AAC9C,IAAI,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC;AACxC,IAAI,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;AAC7B,GAAG;AACH;AACA,EAAE,KAAK,CAAC,GAAG;AACX,IAAI,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;AAC3B,IAAI,MAAM,CAAC,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;AAC1D,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;AAClB,GAAG;AACH;;AC1DK,MAAC,SAAS,GAAG;AAClB,UAAEC,eAAM;AACR,SAAEC,cAAK;AACP;;;;"}