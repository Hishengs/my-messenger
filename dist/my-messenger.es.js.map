{"version":3,"file":"my-messenger.es.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(this.off);\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nconst MAX_SHAKE_HAND = 50;\nconst SHAKE_HAND_INTERVAL = 100;\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n\n  constructor (iframe) {\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.shakehand().then(() => {\n      this.connected = true;\n      this.showDebug('connected');\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > MAX_SHAKE_HAND) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, SHAKE_HAND_INTERVAL);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.iframe.src);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (!this.iframe.src.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (!this.origin) this.origin = e.origin;\n    if (this.origin !== e.origin) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","debugPrefix","padEnd","event","callback","events","push","index","indexOf","splice","undefined","Object","keys","forEach","off","args","cb","call","console","info","e","error","message","MAX_SHAKE_HAND","SHAKE_HAND_INTERVAL","MessengerParent","iframe","onMessage","bind","window","addEventListener","shakehand","then","connected","showDebug","Promise","resolve","reject","shake","ack","shakehandTimes","clearInterval","shakehandTimer","showError","send","setInterval","on","data","contentWindow","postMessage","src","includes","origin","invoke","removeEventListener","offAll","Base","MessengerChild","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"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"}