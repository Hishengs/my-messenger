{"version":3,"file":"my-messenger.es.js","sources":["../src/base.js","../src/parent.js","../src/child.js","../src/index.js"],"sourcesContent":["export default class MessengerBase {\n  flag = '';\n  debug = false;\n  debugPrefix = '';\n  events = {};\n\n  constructor (flag, debug) {\n    this.flag = flag;\n    this.debug = debug;\n    this.debugPrefix = `[messenager.${this.flag}]`.padEnd(20, '>');\n  }\n\n  on(event, callback) {\n    if (typeof callback !== 'function') return;\n    if (!this.events[event]) this.events[event] = [];\n    this.events[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (event && this.events[event]) {\n      if (callback && typeof callback === 'function') {\n        const index = this.events[event].indexOf(callback);\n        this.events[event].splice(index, 1);\n      } this.events[event] = undefined;\n    }\n  }\n\n  offAll () {\n    Object.keys(this.events).forEach(e => this.off(e));\n  }\n\n  invoke (event, ...args) {\n    if (event && this.events[event]) {\n      for (const cb of this.events[event]) {\n        cb.call(this, ...args);\n      }\n    }\n  }\n\n  showDebug (...args) {\n    this.debug && console.info(this.debugPrefix, ...args);\n  }\n\n  showError (e) {\n    this.debug && console.error(this.debugPrefix, typeof e === 'string' ? e : e.message);\n  }\n}","import Base from './base.js';\n\nexport default class MessengerParent extends Base {\n  static debug = false;\n  shakehandTimes = 0;\n  shakehandTimer = null;\n  connected = false;\n  timeout = 5000;\n  interval = 100;\n  maxShakeTimes = 50;\n\n  constructor (iframe, options = {}) {\n    if (typeof iframe === 'string') {\n      iframe = document.querySelector(iframe);\n    }\n    super('parent', MessengerParent.debug);\n    this.iframe = iframe;\n    this.timeout = options.timeout || this.timeout;\n    this.interval = options.interval || this.interval;\n    this.maxShakeTimes = Math.floor(this.timeout / this.interval);\n    this.targetOrigin = options.targetOrigin || iframe.src;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  connect () {\n    return this.checkLoaded()\n      .then(() => this.shakehand())\n      .then(() => {\n        this.connected = true;\n        this.showDebug('connected');\n      });\n  }\n\n  // check if iframe loaded\n  checkLoaded () {\n    return new Promise((resolve, reject) => {\n      this.showDebug('checkLoaded');\n      if (!this.iframe) {\n        reject('no iframe found');\n        return;\n      }\n      this.iframe.addEventListener('load', () => {\n        resolve();\n      });\n      try {\n        const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;\n        if (iframeDoc && iframeDoc.readyState === 'complete') {\n          resolve();\n        }\n      } catch (e) {\n        // throw cross origin access error if loaded, otherwise return document\n        resolve();\n      }\n    });\n  }\n\n  shakehand () {\n    return new Promise((resolve, reject) => {\n      const shake = (ack) => {\n        if (this.shakehandTimes > this.maxShakeTimes) {\n          clearInterval(this.shakehandTimer);\n          this.showError('shakehand failed, max times');\n          reject('shakehand failed, max times');\n          return;\n        }\n        this.shakehandTimes++;\n        this.showDebug(`shakehand: ${this.shakehandTimes}`, ack);\n        this.send('shakehand', { ack });\n      };\n      // start shake\n      this.shakehandTimer = setInterval(shake, this.interval);\n      // on reply\n      this.on('shakehand-reply', ({ ack }) => {\n        // child ack\n        if (ack) {\n          // stop shake\n          clearInterval(this.shakehandTimer);\n          // parent ack\n          shake(true);\n          this.off('shakehand-reply');\n          // resolve\n          resolve();\n        }\n      });\n    });\n  }\n\n  send (event, data) {\n    if (this.iframe && this.iframe.contentWindow) {\n      try {\n        this.iframe.contentWindow.postMessage({ event, data }, this.targetOrigin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage (e) {\n    if (this.targetOrigin !== '*' && !this.targetOrigin.includes(e.origin)) return;\n    const { event, data } = e.data;\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener(\"message\", this.onMessage);\n    this.offAll();\n  }\n}","import Base from './base.js';\n\nexport default class MessengerChild extends Base {\n  static debug = false;\n  origin = '';\n  connected = false;\n\n  constructor (origin) {\n    super('child', MessengerChild.debug);\n    this.origin = origin || document.referrer;\n    this.onMessage = this.onMessage.bind(this);\n    window.addEventListener('message', this.onMessage);\n  }\n\n  connect () {\n    return new Promise(resolve => {\n      // shakehand from parent\n      this.on('shakehand', (data) => {\n        this.showDebug('on.shakehand', data);\n        this.replyShakehand(data).then(resolve);\n      });\n    });\n  }\n\n  replyShakehand ({ ack }) {\n    return new Promise(resolve => {\n      // ack from parent\n      if (ack) {\n        this.showDebug('connected');\n        this.connected = true;\n        this.off('shakehand');\n        resolve();\n        return;\n      }\n      this.showDebug('shakehand-reply');\n      this.send('shakehand-reply', { ack: true });\n    });\n  }\n\n  send (event, data) {\n    if (window.parent && this.origin) {\n      try {\n        window.parent.postMessage({ event, data }, this.origin);\n      } catch (e) {\n        this.showError(e);\n      }\n    }\n  }\n\n  onMessage(e) {\n    if (!this.origin) this.origin = e.origin;\n    if (!this.origin.includes(e.origin)) return;\n    const { event = '', data } = e.data || {};\n    this.showDebug('onMessage', e.data);\n    this.invoke(event, data);\n  }\n\n  close () {\n    this.connected = false;\n    window.removeEventListener('message', this.onMessage);\n    this.offAll();\n  }\n}","import Parent from'./parent.js';\nimport Child from'./child.js';\n\nconst Messenger = {\n  Parent,\n  Child\n};\n\nexport default Messenger;"],"names":["MessengerBase","flag","debug","debugPrefix","padEnd","event","callback","events","push","index","indexOf","splice","undefined","Object","keys","forEach","e","off","args","cb","call","console","info","error","message","MessengerParent","iframe","options","document","querySelector","timeout","interval","maxShakeTimes","Math","floor","targetOrigin","src","onMessage","bind","window","addEventListener","checkLoaded","then","shakehand","connected","showDebug","Promise","resolve","reject","iframeDoc","contentDocument","contentWindow","readyState","shake","ack","shakehandTimes","clearInterval","shakehandTimer","showError","send","setInterval","on","data","postMessage","includes","origin","invoke","removeEventListener","offAll","Base","MessengerChild","referrer","replyShakehand","parent","Messenger","Parent","Child"],"mappings":"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"}